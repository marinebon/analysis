---
title: "FKNMS_Diversity"
author: "Megan Hepner"
date: "3/10/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#rm(list = ls()) #clears workspace

suppressPackageStartupMessages({
  library(ade4) #Calls: mantel.rtest, dudi.mix
  library(ape) #Calls: read.tree, read.nexus, chronopl, as.phylo
  library(automap) #Calls: autoKrige
  #library(car) #Calls: recode
  library(clue) # cluster ensembles, Calls: cl_consensus, cl_ultrametric
  library(DT)
  library(FD) # functional diversity: calls: gowdis 
  library(fpc) #Calls: pamk
  #library(gridExtra) #Calls: grid.arrange
  library(leaflet)
  library(lubridate)
  library(mapplots) #data visualization on maps
  library(maptools)# tools for reading and handling spatial objects
  library(mgcv) #function GAM 
  library(MuMIn) #Calls: dredge
  library(parallel) #Calls: clusterEvalQ,clusterExport,detectCores,makeCluster,parLapply
  library(picante) #Calls: phylosignal
  library(plotrix) #Calls: std.error
  library(plyr) #Calls: ddply
  library(psych) #Calls: pairs.panels
  library(raster) #tools to deal with raster maps 
  library(rerddap) # call data from erddap 
  #library(reshape2) #Calls: dcast, melt
  library(readxl)
  library(RColorBrewer) # pretty color palettes 
  #library(rgeos) #interface to geometry engine - open source (GEOS) - wont install 
  #library(rgdal) #bindings for the geospatial data abstraction library - wont install 
  library(scales) #for transparency
  library(sp) #classes and methods for spatial data
  library(SpadeR) # Sorenzen index (q=0), Horn Index (q=1), Morisita-Horn Index (q=2) 
  library(splines) # regression functions 
  library(stringr) #Calls: str_split_fixed
  library(tidyverse)
  library(tree) #Calls: tree
  library(tsne)
  library(vegan) # biodiveristy functions for richness, simpson, and shannon 

})

select = dplyr::select
```

## Reef Visual Census Background 

Reef fish community data used in this study were collected as part of the multi-agency Reef Visual Census (RVC) (Brandt et al., 2009 [https://www.coris.noaa.gov/activities/fish_monitoring_protocol/]). Fish communities were visually surveyed underwater annually between April and September in the mainland FKNMS (Lower Keys, Middle Keys and Upper Keys) from 1999 to 2012, and biennially from 2012 to 2016. The Dry Tortugas region was surveyed from 1999 to 2000 and biennially from 2004 to 2016.   

The RVC uses a stationary point count method within a randomly selected 7.5 m radius circular plot with a 200m map grid to optimize the observation of conspicuous and diurnally active reef fish, specifically economically and ecologically important reef fish species (Bohnsack and Bannerot, 1986 [https://docs.lib.noaa.gov/noaa_documents/NMFS/TR_NMFS/TR_NMFS_41.pdf]).   

## Objective 

The study sought to analyze and compare changes in species richness, Simpson diversity, Shannon diversity and functional diversity in the FKNMS. Indices were assessed to reveal changes in temporal and spatial variability from 1999 â€“ 2016 throughout the Florida Keys, between four distinct regions of the FKNMS (Upper Keys, Middle Keys, Lower Keys, and Dry Tortugas) and for different levels of management (Ecological Reserves (ER), Sanctuary Preservations Areas (SPA), and Special Use/Research Only Areas (SU/RO)). 

## Diversity indicse as effective number of species 

All indices were computed as effective number of species. Effective number of species is the number of equally abundance species needed to produce the observed value of a diversity index (Jost, 2006; Jost et al., 2010; MacArthur, 1965). Jost, 2006 refers to these as true measures of diversity, where prior to the conversion the diversity indices are simply measures of entropy. 

- Species Richness is the number of species in a habitat sampled,
$$
Richness = sum_{i=1}^S p_i^0        
$$
- Simpson diversity measures the probability that two individuals randomly selected from a sample will belong to different species. 
$$
Simpson = 1 - \sum_{i=1}^S p_i^2        
$$
- Shannon diveristy is a measure of entropy, it is the uncertainty in the species identity of a sample
$$
Shannon = - \sum_{i=1}^S p_i \log_b p_i  
$$
- Functional diversity (Rao's Q) is a measure of pairwise functional differences between species weighted by their relative abundances 
$$
Rao's Q = \sum_{i=1}^S-1 \sum_{j=i+1}^S d_i p_i p_j     
$$
                                      
## Outputs                                                                            
- Species richness, Simpson diversity, Shannon diversity, and Functional diversity as effective number of species by domain
- Species richness, Simpson diversity, Shannon diversity, and Functional diversity as effective number of species by subregion
- Species richness, Simpson diversity, Shannon diversity, and Functional diversity as effective number of species by level of protection
- Species richness, Simpson diversity, Shannon diversity, and Functional diversity as effective number of species by mapgrid 
- Funcitonal dendogram 
- environmental varibales from SERC 

```{r Fetch RVC data}
# csv files to read (since time consuming to create using ERDDAP server calls)
rvc_rds     = 'data/rvc.rds'
rvc_mg_csv  = 'data/rvc_mapgrid_locations.csv'
rvc_spp_csv = 'data/rvc_species_densities.csv'

# assign ERDDAP server URL
eurl = 'http://gcoos4.tamu.edu:8080/erddap/search/'
#http://gcoos4.tamu.edu:8080/erddap/search/index.html?page=1&itemsPerPage=1000
#http://gcoos4.tamu.edu:8080/erddap/search/index.html?page=1&itemsPerPage=1000&searchFor=reef+visual+census

# only load full rvc.rds if need be (since slow)
if (!all(file.exists(c(rvc_mg_csv, rvc_spp_csv)))){
  if (!file.exists(rvc_rds)){
    # create csv files
    
    # search for datasets
    ed_search(query='Reef Visual Census', which='table', url=eurl)
    # TODO / NOTE: ed_search(page_size, page) DO NOT WORK! ACK!
    #ed_search(query='Reef Visual Census', which='table', url=eurl, page=2)
  
    # iterate over years
    all = list()
    
    ids = c(
      # Dry Tortugas
      sprintf('dt%d', c(1999,2000,2004,2006,2008,2010,2012,2014,2016)),
      # Florida Keys
      sprintf('fk%d', c(1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2012, 2014, 2016))) # diff't method 1994:1998
    
    for (id in ids){ # id = ids[1]
    
      # construct id for dataset
      csv_id   = sprintf('data/%s.csv', id)
      csv_vars = sprintf('data/%s_vars.csv', id)
      cat(sprintf('%s\n', id))
      
      if (!file.exists(csv_vars)){
        # get metadata for dataset
        m = try(info(id, url=eurl), silent = T)
        
        if (class(m) == 'try-error') next
        cat(sprintf('  writing %s\n', csv_vars))
        write_csv(m$variables, csv_vars)
      }
      
      if (!file.exists(csv_id)){
      
        # get metadata for dataset
        m = try(info(id, url=eurl), silent = T)
        
        # if id not found, then move onto next year
        if (class(m) == 'try-error'){
          cat(sprintf('  %s NOT FOUND!\n', id)) # fk2013 NOT FOUND! b/c not there
          next
        } 
        
        # try fetching data, up to 10x
        dap_attempts = 1
        while (dap_attempts < 11){
          
          # load data for individual dataset
          cat('  fetching data', ifelse(dap_attempts > 1, sprintf(': attempt %d\n', dap_attempts), '\n'))
          d_id = try(tabledap(m, fields=m$variables$variable_name, url=eurl), silent = T)
          
          # break out of loop if not giving error
          if (!'try-error' %in% class(d_id)) break
          dap_attempts =+ 1
          cat('  error fetching data\n')
        }
      
        # write to csv
        cat('  writing to csv\n')
        d_id %>%
          tbl_df() %>%
          write_csv(csv_id)
        
      } # end if (!file.exists(csv_id))
    } # end for (yr in 1994:2016)
    
    # bind all csv's into one data frame
    cat("bind all csv's\n")
    d = data_frame()
    for (f in list.files('data','[fk|dt][0-9]+\\.csv', full.names=T)){
      cat(' ', f,'\n')
      d_f = read_csv(
        f, progress=F, trim_ws=T,
        col_types = cols(
          protection = col_character()))
      d = bind_rows(d, d_f)
    }
    
    write_rds(d, rvc_rds) # 4.4 GB
  
    # evaluate commonness of columns
    cat('eval common columns')
    vars = data_frame()
    for (f in list.files('data', '[fk|dt][0-9]+_vars\\.csv', full.names = T)){ # f = list.files('data', 'fk[0-9]+_vars\\.csv', full.names = T)[1]
      cat(f)
  
      vars = bind_rows(
        vars,
        read_csv(f) %>%
          mutate(
            id = str_replace(f, 'data/(.*)_vars\\.csv', '\\1')))
    }
    
    v = vars %>%
      select(variable_name, data_type, id) %>% # drop actual_range
      spread(id, data_type)
    
  
  } else {
    # read data
    d = read_rds(rvc_rds)
  }
  
  # show columns (with same class) not consistently available across all datasets
  summary(d)
  
  d %>%
    head() %>%
    datatable()
}
```

## Summarize by mapgrid & species

Next, we aggregate to having average density of species from Secondary Sampling Unit (SSU) and Primary Sampling Unit (PSU) to Map grid (200x200m).  

Variables selected from ERDDAP
- latitude (degrees_north)
- longitude (degrees_east) 
- depth (sea water depth, m)
- scientificName 
- quantificationValue (Mean number of observed fish per species per 5 Minutes, (num))
- habitat_cd
- bottomType
- mapNumber (mpaNumber)
- protection 

```{r aggregate}
if ( !all(file.exists(c(rvc_mg_csv, rvc_spp_csv))) ){
  
  # read data fetched from erddap (erddap_rvc.Rmd)
  rvc = read_rds(rvc_rds)
    
  # summarize individual species counts to PSU
  rvc_psu = rvc %>%
    select(datasetID, eventDate, mapGridNumber, primarySamplingUnit, station_nr, materialSampleID, protection, mapNumber, habitat_cd, bottomType, scientificName, quantificationValue) %>% #selecting data columns from rvc
    filter(!is.na(station_nr)) %>% #removing n/a
    group_by(datasetID, eventDate, mapGridNumber, primarySamplingUnit, scientificName) %>% #
    summarise(
      n_stations = length(unique(station_nr)), #numbre of SSU within a PSU
      q_mean_psu = sum(quantificationValue, na.rm=T) / length(unique(station_nr))) %>% #average species count per PSU
    filter(q_mean_psu > 0, !is.na(q_mean_psu)) # filter: NA, 0's
  
  # mapgrid locations
  mg_location = rvc %>%
    group_by(datasetID, mapGridNumber) %>% # 200m x 200m
    summarise(
      latitude = mean(latitude, na.rm=T), 
      longitude = mean(longitude, na.rm=T))

  # summarize species to mapgrid locations
  rvc_spp = rvc_psu %>%
    left_join(mg_location, by=c('datasetID','mapGridNumber')) %>%
    mutate(
      year = year(eventDate)) %>%
    group_by(year, datasetID,  mapGridNumber, scientificName) %>%
    summarize(
      q_mean = mean(q)) %>% #average number of individual species i detected in a mapgrid 
    ungroup()

  # write to csv
  write_csv(rvc_mg, rvc_mg_csv)
  write_csv(rvc_spp, rvc_spp_csv)
}Show in New WindowClear OutputExpand/Collapse Output
Parsed with column specification:
cols(
  year = col_double(),
  datasetID = col_character(),
  mapGridNumber = col_double(),
  protection = col_integer(),
  scientificName = col_character(),
  q_mean = col_double(),
  n_stations = col_integer()
)

# read in data
rvc_mg = read_csv(rvc_mg_csv)
rvc_spp = read_csv(rvc_spp_csv)

```

##Biodiversity metrics for FKNMS Domain 

# Prep data for domain Florida Keys biodiversity metrics 

```{r wide}
rvc_spp_wide = read_csv(rvc_spp_csv) %>%
  select(
    year, dataset_id = datasetID, 
    mapgridnum = mapGridNumber, scientific_name = scientificName, 
    q_mean, n_stations) 

#vegan prep
rvc_tbl = rvc_spp_wide %>%
  nest(-year) %>%
  mutate(
    data_wide  = map(data, ~ spread(data=.x, scientific_name, q_mean, fill=0)))
```

#Species richness from 1999 - 2016 in the FKNMS
```{r Species Richness for FKNMS domain}  

rvc_tbl = rvc_tbl %>%
  mutate(
    richness = map(
      data_wide, 
      function(x) specnumber(x %>% select(-dataset_id, -mapgridnum, -n_stations))),
    richness_avg = map_dbl(  
      data_wide, 
      function(x){
        x = apply(x %>% select(-c(1:3)), 2, mean) #speacies abundances average across mapgrids by year
        specnumber(x)}))

```

#Simpson diversity as effective number of species from 1999 - 2016 in the FKNMS
```{r Effective Simpson Diversity for FKNMS domain}
# Effective Simpson of the entire FKNMS 
rvc_tbl = rvc_tbl %>%
  mutate(
    eff_simpson = map(
      data_wide, 
      function(x) 1 / (1 - diversity(x %>% select(-dataset_id, -mapgridnum, -n_stations), index='simpson'))),
    eff_simpson_avg = map_dbl(  
       data_wide, 
       function(x){
          x = apply(x %>% select(-c(1:3)), 2, mean) #speacies abundances average across mapgrids by year
          1 / (1 - diversity(x, index='simpson'))}))
  
``` 

#Shannon diversity as effective number of species from 1999 - 2016 in the FKNMS
```{r Effective Shannon diversity for FKNMS domain}

rvc_tbl = rvc_tbl %>%
  mutate(
    eff_shannon = map(data_wide, function(x) exp(diversity(x %>% select(-dataset_id, -mapgridnum, -n_stations), index='shannon'))),
    eff_shannon_avg = map_dbl(  
      data_wide, 
      function(x){
        x = apply(x %>% select(-c(1:3)), 2, mean) #speacies abundances average across mapgrids by year
        exp(diversity(x, index='shannon'))})) 

```

#Functional diversity as effective number of species from 1999 - 2016 in the FKNMS
```{r Effective Functional diversity for FKNMS domain, eval = F}

```

FKNMS domain diversity plots
```{r FKNMS domain plots}

#simpson diveristy with lm 
ggplot(data = rvc_tbl, aes(x = year, y = eff_simpson_avg)) +
  geom_smooth(fill = "darkturquoise", colour = "magenta", size = 2, method = "lm") + #99% CI
  geom_point() +
  ggtitle("Simpson Diversity") +
  xlab("Year") +
  ylab("Effective Number of Species") 

#simpson diversity with loess 
ggplot(data = rvc_tbl, aes(x = year, y = eff_simpson_avg)) +
  geom_smooth(fill = "darkturquoise", colour = "magenta", size = 2, method = "loess") + 
  geom_point() +
  ggtitle("Simpson Diversity") +
  xlab("Year") +
  ylab("Effective Number of Species") +
  scale_x_continuous(breaks = c(1998, 2000, 2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  scale_y_continuous(breaks = c(5, 10, 15, 20, 25, 30, 35, 40))

#simson and shannon by domain with loess 
ggplot(data = rvc_tbl, aes(x = year)) +
  geom_point(aes(y = eff_simpson_avg, color = "eff_simpson_avg")) + geom_smooth(aes(y = eff_simpson_avg, color = "eff_simpson_avg"), method = "loess") +
  geom_point(aes(y = eff_shannon_avg, color = "eff_shannon_avg")) + geom_smooth(aes(y = eff_shannon_avg, color = "eff_shannon_avg"), method = "loess") +
  ggtitle("Reef Fish Biodiversity in the FKNMS") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Year", y = "Effective Number of Species", color = "Diversity index") +
  scale_colour_manual(values = c("blue", "magenta"), labels=c("Shannon diversity", "Simpson diversity")) +
  scale_x_continuous(breaks = c(1998, 2000, 2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  scale_y_continuous(breaks = c(5, 10, 15, 20, 25, 30, 35, 40))

#simson and shannon by domain with lm
ggplot(data = rvc_tbl, aes(x = year)) +
  geom_point(aes(y = eff_simpson_avg, color = "eff_simpson_avg")) + geom_smooth(aes(y = eff_simpson_avg, color = "eff_simpson_avg"), method = "lm") +
  geom_point(aes(y = eff_shannon_avg, color = "eff_shannon_avg")) + geom_smooth(aes(y = eff_shannon_avg, color = "eff_shannon_avg"), method = "lm") +
  ggtitle("Reef Fish Biodiversity in the FKNMS") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Year", y = "Effective Number of Species", color = "Diversity index") +
  scale_colour_manual(values = c("blue", "magenta"), labels=c("Shannon diversity", "Simpson diversity")) +
  scale_x_continuous(breaks = c(1998, 2000, 2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  scale_y_continuous(breaks = c(5, 10, 15, 20, 25, 30, 35, 40))

#simson and shannon by domain 
ggplot(data = rvc_tbl, aes(x = year)) +
  geom_point(aes(y = eff_simpson_avg, color = "eff_simpson_avg")) + geom_line(aes(y = eff_simpson_avg, color = "eff_simpson_avg")) +
  geom_point(aes(y = eff_shannon_avg, color = "eff_shannon_avg")) + geom_line(aes(y = eff_shannon_avg, color = "eff_shannon_avg")) +
  ggtitle("Reef Fish Biodiversity in the FKNMS") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Year", y = "Effective Number of Species", color = "Diversity index") +
  scale_colour_manual(values = c("darkturquoise", "magenta"), labels=c("Shannon diversity", "Simpson diversity")) +
  scale_x_continuous(breaks = c(1998, 2000, 2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  scale_y_continuous(breaks = c(5, 10, 15, 20, 25, 30, 35, 40))

#richness, simpson, shannon by domain 
ggplot(data = rvc_tbl, aes(x = year)) +
  geom_point(aes(y = richness_avg, color = "richness_avg")) + geom_line(aes(y = richness_avg, color = "richness_avg")) +
  geom_point(aes(y = eff_simpson_avg, color = "eff_simpson_avg")) + geom_line(aes(y = eff_simpson_avg, color = "eff_simpson_avg")) +
  geom_point(aes(y = eff_shannon_avg, color = "eff_shannon_avg")) + geom_line(aes(y = eff_shannon_avg, color = "eff_shannon_avg")) +
  ggtitle("Reef Fish Biodiversity in the FKNMS") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Year", y = "Effective Number of Species", color = "Diversity index") +
  scale_colour_manual(values = c("darkturquoise", "magenta", "blue"), labels=c("Shannon diversity", "Simpson diversity", "Richness")) +
  scale_x_continuous(breaks = c(1998, 2000, 2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016))+
  scale_y_continuous(breaks = c(0, 50, 100, 150, 200, 250, 300))
 
```

## Biodiversity metrics by subregion 

Summarize abundance by subregion 

 1. Upper Keys 
        + latitude  >24.95
1. Middle Keys
        + latitude  >24.63 and <= 24.95
        + longitude >-81.10 and <= -80.45
1. Lower Keys
        + latitude  >24.55 and <= 24.63
        + longitude >-82.65 and <=-81.10
1. Dry Tortugas 
        + latitude  >24.55 and <= 24.75
        + longitude >-83.5 and <=-82.65

```{r Define subregion}

mg_subregion <- left_join(rvc_mg, rvc_spp) #added lat, long: datasetID, mapGridNumber, latitude, longitude, year, protection

#add column 'subregion' with observations 'UK, MK, LK, DT' 
mg_subregion = mg_subregion %>% 
  mutate(
    subregion = ifelse (
      latitude > 24.95, 
      "upper_keys",
      ifelse(
        latitude > 24.63 & latitude <= 24.95 & longitude >= -81.10 & longitude <= -80.45,
        "middle_keys",
        ifelse(
          latitude >24.55 & latitude <= 24.63 & longitude >= -82.65 & longitude <= -81.10,
          "lower_keys",
          ifelse(
            latitude >24.55 && latitude <= 24.75 & longitude >= -83.5 && longitude <= -82.65,
            "dry_tortugas")))))

subregion_tbl = mg_subregion %>% #year, subregion, data(list)
  group_by(year,subregion)  %>%
  nest() #year, subregion, data(list of 8 variables: datasetID mapGridNumber latitude longitude protection scientificName q_mean n_stations)

```

```{r Prep data for subregion biodiversity metrics}

map = purrr::map
#map function: the first argument to all map functions is the vector to operate on. The second argument, .f specifies what to do with each piece. map takes a vector and returns a list

#x = mean()
#apply(x %>% select(-c(1:6)), 2, mean)

subregion_tbl = subregion_tbl %>%
  mutate(
    sp_abun_sr = map( #datasetID,mapGridNumber, lat, long, protection, n_stations, all species detected 
      data, #datasetID,mapGridNumber, lat, long, protection, scientificName, q_mean, n_stations
      ~ spread(data=.x, scientificName, q_mean, fill=0))) #key=scientificName, value = q_mean

```

#Species richness from 1999 - 2016 in the FKNMS by subregion
```{r Species richness by subregion}

subregion_tbl = subregion_tbl %>%
  mutate(
    richness_sr = map(
      sp_abun_sr, 
      function(x) specnumber(x %>% select(-c(1:6)))), #compute species richness by sr #removing columns datasetID, mapGridNumber, latitude, longitude, protection, n_stations 
    richness_sr_avg = map_dbl(
      sp_abun_sr, 
      function(x){
        x = apply(x %>% select(-c(1:6)), 2, mean)
       specnumber(x)})) 

```

#Simpson diversity as effective number of species from 1999 - 2016 in the FKNMS by subregion
```{r Effective Simpson diversity by subregion}

subregion_tbl =  subregion_tbl %>%
  mutate(
    effective_simpson_sr = map( #effective simpson by mapgrid 
      sp_abun_sr, 
      function(x) 1 / (1 - diversity(x %>% select(-c(1:6)), index='simpson'))),
    # effective simpson averaged across mapgrids
    # eff_simpson_sr_avg = map_dbl(
    #   effective_simpson_sr,
    #   ~ mean(.x, na.rm=T)),
    # effective simpson using avg species abundance across whole subregion-year
    eff_simpson_sr_avg = map_dbl(
      sp_abun_sr, 
      function(x){
        x = apply(x %>% select(-c(1:6)), 2, mean)
        1 / (1 - diversity(x, index='simpson'))}))

# TODO: Why/how are eff_simpson_sr_avg & eff_simpson_sr_avg different? Which to use?

#TODO: check if individuals that were not detected to species level were removed before computing diversity indices 
  
```

#Shannon diversity as effective number of species from 1999 - 2016 in the FKNMS by subregion
```{r Effective Shannon diversity by subregion}

subregion_tbl =  subregion_tbl %>%
  mutate(
    eff_shannon_sr = map(
      sp_abun_sr, 
      function(x) exp(diversity(x %>% select(-c(1:6)), index='shannon'))),
    eff_shannon_sr_avg = map_dbl(
      sp_abun_sr, 
      function(x){
        x = apply(x %>% select(-c(1:6)), 2, mean)
        exp(diversity(x, index='shannon'))}))

```

#Functional diversity as effective number of species from 1999 - 2016 in the FKNMS by subregion
```{r Effective Functional diversity by subregion}

```

#Plots of diversity by subregion 
```{r Subregion plots}

#Simpson diversity by Subregion, with LM 
ggplot(data = subregion_tbl, aes(x = year, y = eff_simpson_sr_avg, subregion, group = subregion)) +
  geom_smooth(fill = "darkturquoise", colour = "magenta", size = 1, method = "lm") +
  geom_point() +
  facet_grid(subregion ~ .) +
  theme(strip.background = element_blank(), strip.text.y = element_blank()) +
  ggtitle("Simpson Diversity by Subregion") +
  labs(x = "Year", y = "Effective Number of Species", colour = "Subregions") +
  scale_color_hue(labels = c("Dry Tortugas", "Lower Keys", "Middle Keys", "Upper Keys"))

#plot using loess - what does loess do??
# qplot(year, eff_simpson_sr_avg, data = subregion_tbl, color = subregion, geom = c("point", "smooth"), method = "loess") +
#   facet_grid(subregion ~ .) +
#   theme(strip.background = element_blank(), strip.text.y = element_blank()) +
#   ggtitle("Simpson Diversity") +
#   labs(x = "Year", y = "Effective Number of Species", colour = "Subregion") +
#   scale_color_hue(labels = c("Dry Tortugas", "Lower Keys", "Middle Keys", "Upper Keys"))

# #plot using lm 
# qplot(year, eff_simpson_sr_avg, data = subregion_tbl, color = subregion, geom = c("point", "smooth"), method = "lm", formula = y ~ ns(x, 2), se = T) +
#   facet_grid(subregion ~ .) +
#   theme(strip.background = element_blank(), strip.text.y = element_blank()) +
#   ggtitle("Simpson Diversity") +
#   labs(x = "Year", y = "Effective Number of Species", colour = "Subregion") +
#   scale_color_hue(labels = c("Dry Tortugas", "Lower Keys", "Middle Keys", "Upper Keys"))
# 
# #plot using gam
# qplot(year, eff_simpson_sr_avg, data = subregion_tbl, color = subregion, geom = c("point", "smooth"), method = "gam") +
#   facet_grid(subregion ~ .) +
#   theme_update(plot.title = element_text(hjust = 0.5)) +
#   ggtitle("Simpson Diversity") +
#   labs(x = "Year", y = "Effective Number of Species", colour = "Subregion") +
#   scale_color_hue(labels = c("Dry Tortugas", "Lower Keys", "Middle Keys", "Upper Keys")) +
#   theme(strip.background = element_blank(), strip.text.y = element_blank()) + #removes facet grid title box
#   ylim(5, 25) +
#   xlim(1999, 2016)

# #whole FKNMS Shannon 
#  ggplot(data = subregion_tbl, mapping = aes(x = year, y = eff_shannon_sr_avg)) + 
#   geom_point(mapping = aes(color = subregion)) + 
#   geom_smooth() +
#   ggtitle("Shannon Diversity in the FKNMS") +
#   labs(x = "Year", y = "Effective Number of Species", colour = "Subregions") +
#   scale_color_hue(labels = c("Dry Tortugas", "Lower Keys", "Middle Keys", "Upper Keys"))
#  
# #lm plot 
# qplot(year, eff_shannon_sr_avg, data = subregion_tbl, color = subregion, geom = c("point", "smooth"), method = "lm") +
#   facet_grid(subregion ~ .) +
#   theme(strip.background = element_blank(), strip.text.y = element_blank()) +
#   ggtitle("Shannon Diversity") +
#   labs(x = "Year", y = "Effective Number of Species", colour = "Subregion") +
#   scale_color_hue(labels = c("Dry Tortugas", "Lower Keys", "Middle Keys", "Upper Keys")) 
#   #scale_x_continuous(breaks = c(2000, 2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016)) +
#   #theme(axis.text.x = element_text(angle = 45))

#gam plot
# qplot(year, eff_shannon_sr_avg, data = subregion_tbl, color = subregion, geom = c("point", "smooth"), method = "gam") +
#   facet_grid(subregion ~ .) +
#   theme(strip.background = element_blank(), strip.text.y = element_blank()) +
#   ggtitle("Shannon Diversity") +
#   labs(x = "Year", y = "Effective Number of Species", colour = "Subregion") +
#   scale_color_hue(labels = c("Dry Tortugas", "Lower Keys", "Middle Keys", "Upper Keys"))

#simpson and shannon 
ggplot(data = subregion_tbl, aes(x = year)) +
  geom_point(aes(y = eff_simpson_sr_avg, color = "eff_simpson_sr_avg" )) +
  geom_point(aes(y = eff_shannon_sr_avg, color = "eff_shannon_sr_avg")) +
  geom_line(aes(y = eff_simpson_sr_avg, color = "eff_simpson_sr_avg")) +
  geom_line(aes(y = eff_shannon_sr_avg, color = "eff_shannon_sr_avg")) +
  facet_grid(subregion ~ .) + 
  scale_colour_manual(values = c("darkturquoise", "magenta"), labels=c("Shannon diversity", "Simpson diversity")) +
  ggtitle("Reef Fish Biodiversity by Subregion in the FKNMS") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Year", y = "Effective Number of Species", color = "Diversity index") +
  scale_x_continuous(breaks = c(1998, 2000, 2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016)) 


#richness, simpson, shannon by subregion
ggplot(data = subregion_tbl, aes(x = year)) +
  geom_point(aes(y = richness_sr_avg, color = "richness_sr_avg")) +
  geom_point(aes(y = eff_shannon_sr_avg, color = "eff_shannon_sr_avg")) +
  geom_point(aes(y = eff_simpson_sr_avg, color = "eff_simpson_sr_avg" )) +
  geom_line(aes(y = richness_sr_avg, color = "richness_sr_avg")) +
  geom_line(aes(y = eff_shannon_sr_avg, color = "eff_shannon_sr_avg")) +
  geom_line(aes(y = eff_simpson_sr_avg, color = "eff_simpson_sr_avg")) + 
  facet_grid(subregion ~ .) + 
  scale_colour_manual(values = c("darkturquoise", "magenta", "blue"), labels=c("Shannon diversity", "Simpson diversity", "Richness")) +
  ggtitle("Reef Fish Biodiversity by Subregion in the FKNMS") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Year", y = "Effective Number of Species", color = "Diversity index") +
  scale_x_continuous(breaks = c(1998, 2000, 2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016)) 

```


## Biodiversity metrics by level of protection
- 'protection'; 0 = not protected, 1 = protected, 2 = not protected 
- "mapNumber" = "mpaNumber"; 0 - 28 
    0	Unprotected                 [unprotected]
    1	Carysfort                   [Carysfort Sanctuary Preservation Area]
    2	Elbow                       [Elbow Sanctuary Preservation Area]
    3	Key_Largo_Dry_Rocks         [Key Largo Dry Rocks Sanctuary Preservation Area]
    4	Grecian_Rocks               [Grecian Rocks Sanctuary Preservation Area]
    5	French                      [French Reef Sanctuary Preservation Area]
    6	Molasses                    [Molasses Reef Sanctuary Preservation Area]
    7	Conch_Reef                  [Conch Reef Sanctuary Preservation Area]
    8	Conch_RO                    [Conch Reef Research Only Area]
    9	Davis                       [Davis Reef Sanctuary Preservation Area]
    10 Hen_Chickens               [Hen and Chickens Sanctuary Preservation Area]
    11 Cheeca_Rocks               [Cheeca Rocks Sanctuary Preservation Area]
    12 Alligator                  [Alligator Reef Sanctuary Preservation Area]
    13 Tennessee                  [Tennesse Reef Research Only Area]
    14 Coffins_Patch              [Coffins Patch Sanctuary Preservation Area]
    15 Sombrero                   [Sombrero Key Sanctuary Preservation Area]
    16 Looe_Key                   [Looe Key Sanctuary Preservation Area]
    17 Looe_RO                    [Looe Key Research Only Area]
    18 Newfound_Harbor            [Newfound Harbor Key Sanctuary Preservation Area]
    19 East_Sambo                 [Eastern Sambo Research Only Area]
    20 West_Sambo                 [Western Sambo Ecological Reserve]
    21 East_Dry_Rocks             [Eastern Dry Rocks Sanctuary Preservation Area]
    22 Rock_Key                   [Rock Key Sanctuary Preservation Area]
    23 Sand_Key                   [Sand Key Sanctuary Preservation Area]
    24 North Ecological Reserve   [Tortugas North Ecological Reserve]
    25 South Ecological Reserve   [Tortugas South Ecological Reserve]
    26 Research Natural Area      [unprotected]
    27 Not Protected              [unprotected]
    28 Not Protected              [unprotected]

```{r Define levels of protection}

# TODO: change map_Number = mpa_number

#add column 'managed' with observations unprotected and protected 
mpa_tbl = mg_subregion %>% 
  mutate(
    managed = ifelse (
      protection == 0 | 2,
      "unprotected",
       ifelse(
         protection == 1,
         "protected"))   #only getting unprotected and no protected ??

# add column 'mpa_name' with: Sanctuary Preservation Areas (18) Ecological Reserves (3) Special Use/Research Only (4)

# mpa_tbl = mpa_tbl %>% 
#   mutate(   
#     mpa_name = ifelse(
#       mpa_number = 0 | 26 | 27 | 28, 
#       "unprotected",
#       ifelse(
#         mpa_number = 1, "Carysfort_SPA",
#         ifelse(
#           mpa_number = 2, "Elbow_SPA",
#           ifelse(
#           mpa_number = 3, "Key_Largo_Dry_Rocks_SPA",
#           ifelse(
#           mpa_number = 4, "Grecian_Rocks_SPA",
#           ifelse(
#           mpa_number = 5, "French_SPA",
#           ifelse(
#           mpa_number = 6, "Molasses_SPA",
#           ifelse(
#           mpa_number = 7, "Conch_Reef_SPA",
#           ifelse(
#           mpa_number = 8, "Conch_RO",
#           ifelse(
#           mpa_number = 9, "Davis_SPA",
#           ifelse(
#           mpa_number = 10, "Hen_Chickens_SPA",
#           ifelse(
#           mpa_number = 11, "Cheeca_Rocks_SPA",
#           ifelse(
#           mpa_number = 12, "Alligator_SPA",
#           ifelse(
#           mpa_number = 13, "Tennessee_RO",
#           ifelse(
#           mpa_number = 14, "Coffins_Patch_SPA",
#           ifelse(
#           mpa_number = 15, "Sombrero_SPA",
#           ifelse(
#           mpa_number = 16, "Looe_Key_SPA",
#           ifelse(
#           mpa_number = 17, "Looe_Key_RO",
#           ifelse(
#           mpa_number = 18, "Newfound_Harbor_SPA",
#           ifelse(
#           mpa_number = 19, "Eastern_Sambo_RO",
#           ifelse(
#           mpa_number = 20, "Western_Sambo_SPA",
#           ifelse(
#           mpa_number = 21, "East_Dry_Rocks_SPA",
#           ifelse(
#           mpa_number = 22, "Rock_Key_SPA",
#           ifelse(
#           mpa_number = 23, "Sand_Key_SPA",
#           ifelse(
#           mpa_number = 24, "Dry_Tortugas_North_ER",
#           ifelse(
#           mpa_number = 25, "Dry_Tortugas_South_ER"
#       )))))))))))))))))))))))))))

mpa_tbl = mpa_tbl %>% #year, subregion, data(list)
  group_by(year, managed)  %>%
  nest() #year, subregion, data(list of 8 variables: datasetID mapGridNumber latitude longitude protection scientificName q_mean n_stations)

        
```

#Prep data by level of protection 
```{r Prep data by level of protection}

mpa_tbl = mpa_tbl %>%
  mutate(
    sp_abun_prot = map( #datasetID,mapGridNumber, lat, long, protection, n_stations, all species detected 
      data, #datasetID,mapGridNumber, lat, long, protection, scientificName, q_mean, n_stations
      ~ spread(data=.x, scientificName, q_mean, fill=0))) #key=scientificName, value = q_mean
```

#Species richness from 1999 - 2016 in the FKNMS by level of protection
```{r Species richness by level of protection}

mpa_tbl = mpa_tbl %>%
  mutate(
    richness_mpa = map(
      sp_abun_prot, 
      function(x) specnumber(x %>% select(-c(1:7)))), #compute species richness by sr #removing columns datasetID, mapGridNumber, latitude, longitude, protection, n_stations 
    richness_mpa_avg = map_dbl(
      sp_abun_prot, 
      function(x){
        x = apply(x %>% select(-c(1:7)), 2, mean)
       specnumber(x)}))  #shit ton of NA's "returning NAargument is not numeric or logical"

```

#Simpson diversity as effective number of species from 1999 - 2016 in the FKNMS by level of protection
```{r Effective Simpson diversity by level of protection}
mpa_tbl =  mpa_tbl %>%
  mutate(
    eff_simpson_mpa = map( #effective simpson by mapgrid 
      sp_abun_prot, 
      function(x) 1 / (1 - diversity(x %>% select(-c(1:7)), index='simpson'))),
    eff_simpson_mpa_avg = map_dbl(
      sp_abun_prot, 
      function(x){
        x = apply(x %>% select(-c(1:7)), 2, mean)
        1 / (1 - diversity(x, index='simpson'))}))
```

#Shannon diversity as effective number of species from 1999 - 2016 in the FKNMS by level of protection
```{r Effective Shannon diversity by level of protection}

mpa_tbl =  mpa_tbl %>%
  mutate(
    eff_shannon_mpa = map( #effective simpson by mapgrid 
      sp_abun_prot, 
      function(x) exp(diversity(x %>% select(-c(1:7)), index='shannon'))),
    eff_shannon_mpa_avg = map_dbl(
      sp_abun_prot, 
      function(x){
        x = apply(x %>% select(-c(1:7)), 2, mean)
        exp(diversity(x, index='shannon'))}))

```

#Functional diversity as effective number of species from 1999 - 2016 in the FKNMS by level of protection
```{r Effective Functional diversity by level of protection}

```

#Plots of diversity in the FKNMS by level of protection
```{r plots by level of protection}

ggplot(data = mpa_tbl, aes(x = year)) +
  geom_point(aes(y = richness_mpa_avg, color = "richness_mpa_avg")) +
  geom_point(aes(y = eff_simpson_mpa_avg, color = "eff_simpson_mpa_avg")) +
  geom_point(aes(y = eff_shannon_mpa_avg, color = "eff_shannon_mpa_avg")) +
  geom_line(aes(y = richness_mpa_avg, color = "richness_mpa_avg")) +
  geom_line(aes(y = eff_simpson_mpa_avg, color = "eff_simpson_mpa_avg")) +
  geom_line(aes(y = eff_shannon_mpa_avg, color = "eff_shannon_mpa_avg")) +
  facet_grid(managed ~ .) + 
  ggtitle("Reef Fish Diversity by MPA") +
  labs(x = "Year", y = "Effective Number of Species", color = "Diversity") +
  scale_colour_manual(values = c("darkturquoise", "magenta", "blue"), labels=c("Shannon diversity", "Simpson diversity", "Richness")) +
  ggtitle("Reef Fish Biodiversity by Subregion in the FKNMS") +
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(x = "Year", y = "Effective Number of Species", color = "Diversity index") +
  scale_x_continuous(breaks = c(1998, 2000, 2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016)) +
  scale_y_continuous(breaks = c(0, 50, 100, 150, 200, 250, 300))

```

## Biodiversity metrics by magrid 
```{r data wide with lat long}

#Unnest tibble so the data is in long format with columns: year, datasetID, mapGridNumber, latitude, longitude, protection, subregion, richness, simpson, shannon 

mg = subregion_tbl %>% unnest(sp_abun_sr, sp_richness_sr, effective_simpson_sr, effective_shannon_sr) #year, subregion, eff_simpson_sr_avg, eff_shannon_sr_avg, sp_richness_sr, effective_simpson_sr, effective_shannon_sr, datasetID, mapGridNumber, latitude, longitude, protection, n_stations, and all species

map_mg = mg %>%
  select(year, datasetID, mapGridNumber, latitude, longitude, protection, subregion, sp_richness_sr, effective_simpson_sr, effective_shannon_sr)

library(maptools)
library(rgdal)

trial <- readOGR('./Florida_Keys_Benthics_USGS_2006')

```

## Functional distance (modified from Lefcheck)
```{r Functional distance matrix}
rvc_grp = read_csv('data/rvc_spp_grouped.csv')

# wide: common_name x traits
d_traits = rvc_grp %>% 
  group_by(
    common_name, maxlength, trophic_level, trophic_group, water_column, diel_activity, substrate_type, complexity, gregariousness) %>%
  summarize(
    n = n()) %>%
  select(-n) %>%
  ungroup() %>%
  mutate(
    # ordinal traits
    complexity = factor(
      complexity, levels=c("Low","Medium","High"), ordered=T)) %>%
  arrange(common_name) %>%
  as.data.frame()

#dim(d_traits) 333, 8 (species*traits)

# conform to: species x traits
rownames(d_traits) = d_traits$common_name
d_traits = select(d_traits, -common_name)
head(d_traits)

#Calculate Gower distances
traits.dist=gowdis(d_traits,ord="podani")

#Use clustering method to produce ultrametric dendrogramBecause values of Rao's Q can be maximized when fewer than the max number of functional types are present unless distances are ultramtetric 

#to account for sensitivity in clustering use multiple algorithms  (Mouchet et al., 2008) 
tree_methods = c("single","complete","average","mcquitty","ward.D") #average is best clustering method 
trees=lapply(tree_methods,function(i) hclust(traits.dist, method=i))
#par(mfrow=c(3,2))
#for(i in 1:length(trees)) {plot(trees[[i]])}

#convert trees to ultrametric
trees.ultra=lapply(trees,function(i) cl_ultrametric(as.hclust(i)))

#Plot each tree
par(mfrow=c(3,2))
for (i in 1:length(trees.ultra)) {plot(trees.ultra[[i]])}

#Build the consensus tree (Mouchet et al 2008 Oikos) from package clue 
ensemble.trees=cl_ensemble(list=trees) #list of clusterings 
class(ensemble.trees)
consensus.tree=cl_consensus(ensemble.trees) #synthesizes the information in the elements of a cluster ensemble into a single clustering 
#plot(consensus.tree)

#Calculate dissimilarity values for each tree using 2-norm (Merigot et al 2010 Ecology) to determine which tree best preserves orignial distances
all.trees=c(trees.ultra,consensus.tree[1])
names(all.trees)=c(tree_methods,"consensus")
trees.dissim=lapply(all.trees,function(i) cl_dissimilarity(i,traits.dist,method="spectral")) #spectral norm (2-norm) of the differences of the ultrametrics

#Identify best tree and isolate
trees.dissim2=do.call(rbind,trees.dissim)
min.tree=which.min(trees.dissim2)
names(all.trees)[min.tree]
func.dist=all.trees[names(all.trees)==names(all.trees)[min.tree]][[1]]

#Confirm lowest 2-norm value
cl_dissimilarity(func.dist,traits.dist,method="spectral")

#Scale by the max value so that all values are between 0-1 (clue package)
func.dist=func.dist/max(func.dist)

#Plot the best tree
par(mfrow=c(1,1))
par(mar=c(3,1,0,16))
plot(func.dist,horiz=TRUE)
#Save plot: 10" x 15"

#Write newick tree
write.tree(as.phylo(as.hclust(func.dist)),"data/dendro_functional.nwk")

#Visualize species' differences in multivariate trait space
#Perform k-means clustering with no a priori specification for k
traits.kclus=pamk(traits.dist,krange=2:10)
# #Perform multidimensional scaling on functional dendrogram
traits_nmds=metaMDS(traits.dist,k=traits.kclus$nc,trymax=500)
# #Plot in two dimensions
par(mar=c(4,4,1,1))
ordiplot(traits_nmds,type="n")
#Assign colors to different groups
groups=levels(factor(traits.kclus$pamobject$clustering))
points.symbols=15:16
points.colors=c("firebrick3","cornflowerblue")
for(i in seq_along(groups)) {
   points(traits_nmds$points[traits.kclus$pamobject$clustering==groups[i],],
          pch=points.symbols[i],col=points.colors[i],cex=1.4) }
 ordispider(traits_nmds,factor(traits_kclus$pamobject$clustering),label=F)
 ordihull(traits_nmds,factor(traits.kclus$pamobject$clustering),lty="dotted")
 orditorp(traits_nmds,dis="sites",pcex=0,air=0.5,col="grey10",cex=0.8)
 
``` 

Trait matrix visualization 
[http://jkunst.com/r/pokemon-visualize-em-all/]
```{r trait visualization}

```

## Compute Simpson and Functional Diversity for Alpha (subregions) and Gamma (FKNMS)

```{r Alpha diversity - Subregion}

# species abudance by subregion 
subregion_abun<-apply(abundances,1,sum)

# species relative abundances by subregion 
subregion_relabun<-abundances/subregion_abun 

# species richness by subregion
subregion_richness<-apply(abundances,1, function(x) {length(which(x>0))} )  

# functional diversity (effective number of species) by subregion
subregion_func_div=1/(1-apply(subregion_relabun, 1, function(x) t(x) %*%  func.dist %*% x))

# Gini-Simpson diversity (effective number of species) by subregion
species.dist=matrix(1,ncol(abundances),ncol(abundances))-diag(rep(1,ncol(abundances))) 
subregion_simpson_div=1/(1-apply(subregion_relabun,1, function(x) t(x) %*% species.dist %*% x))

```

```{r Gamma Diversity - FKNMS}

# species regional abudance 
regional_abun<-apply(abundances,2,sum)

 # regional species richness
regional_richness<-apply(abundances,2,function(x) {length(which(x>0))} ) 

#regional species relative abundance
regional_relabun <- regional_abun/sum(regional_abun)  

# regional functional diversity (effective number of species)
regional.func.div=1/(1-apply(regional_relabun, 1, function(x) t(x) %*%  func.dist %*% x))

# regional Gini-Simpson diversity (effective number of species)
regional.simpson.div=1/(1-apply(regional_relabun,1,function(x) t(x) %*% species.dist %*% x))

```

