---
title: "Testing ERDDAP"
author: "Ben Best"
date: "August 9, 2016"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages({
  library(rerddap) # install.packages("rerddap")
  library(tidyverse)
  library(stringr)
  library(lubridate)
  library(DT)
  library(dygraphs)
  library(xts)
})
```

## Data

* [Marine Biodiversity Observation Network](http://mbon.ioos.us/)
* [Marine Biodiversity Observation Network: Florida Keys Reef Fish Visual Census](http://mbon.ioos.us/#module-metadata/53cb8d58-ae4d-43e1-aea3-640db9491db2/9436fa4e-73aa-4189-b551-b3b484a9d4e9)
    
    > This fish survey timeseries contains count and length measurements for 340 species observed between 1995 and 2012 along the southern coast of Florida.
    >
    > Filter options:
    > - Alpha: takes the average of event values within the selected area
    > - Gamma: groups all events within the selected area and treats them as a single sample
    > - Beta: Gamma/Alpha
    > 
    > Richness: Count of distinct species
    > - % Dominance (Berger-Parker): Numerical importance of the most abundant species
    > - Shannon-Wiener Diversity: This index quantifies the uncertainty associated with species prediction
    > - Pielou's Evenness: Species evenness quantifies how close in count each species is within a sampling event
    
    - [ERDDAP - Information about 1994 Florida Keys Reef Visual Census, v3.3, from Marine Biodiversity Observation Network](http://gcoos4.tamu.edu:8080/erddap/info/fk1994/index.html)

* [Marine Biodiversity Observation Network: SECOORA Fisheries and Wildlife Monitoring - Fisheries-Independent Monitoring, Assessment, and Prediction (FIMMAP)](http://mbon.ioos.us/#module-metadata/07a25110-e19e-4ad4-b29c-a6978b68a90d/200d32d2-c827-451d-846e-f3413090dbfa)
* [Marine Biodiversity Observation Network: SECOORA Fisheries and Wildlife Monitoring - Marine Resources Monitoring, Assessment, and Prediction (MARMAP)](http://mbon.ioos.us/#module-metadata/07a25110-e19e-4ad4-b29c-a6978b68a90d/7b846aaa-db05-408d-bd77-ae4f12281480)



* [RVC | Data Portal](http://www.sefsc.noaa.gov/rvc_analysis20/?acton=index)
* [jeremiaheb/rvc: New implementation of the rvcstats package, which produces summary statistics for the South Florida Reef Visual Census](https://github.com/jeremiaheb/rvc)



## Time Series

Technical resources:

* [rerddap](https://github.com/ropensci/rerddap): R client for working with ERDDAP servers
* [dygraphs](http://rstudio.github.io/dygraphs/): interactive time series visualization
* [rmarkdown - HTML documents](http://rmarkdown.rstudio.com/html_document_format.html)

### Annotations

* [Annotations](http://rstudio.github.io/dygraphs/gallery-annotations.html) for Flower Garden Banks event

### Shiny Integration

* [Using in Shiny Applications](http://rstudio.github.io/dygraphs/shiny.html): eg `input$series_date_window` for dygraph called `series`


## Plot Map

### Combine ERDDAP datasets across years for Florida Keys Reef Visual Census

[ERDDAP: gcoos4.tamu.edu](http://gcoos4.tamu.edu:8080/erddap/info/index.html?page=1&itemsPerPage=1000)

```{r prep FL Keys fish, eval=F}
# csv files to read (since time consuming to create using ERDDAP server calls)
csv_d    = 'data/erddap_Florida-Keys-Reef-Visual-Census.csv'
rds_d    = 'data/erddap_Florida-Keys-Reef-Visual-Census.rds'
csv_cols = 'data/erddap_Florida-Keys-Reef-Visual-Census_columns.csv'

# assign ERDDAP server URL
eurl = 'http://gcoos4.tamu.edu:8080/erddap/' # search/index.html?page=1&itemsPerPage=1000&searchFor=Florida+Keys+Reef+Fish+Visual+Census

if (!file.exists(rds_d)){
  # create csv files
  
  # search for datasets
  ed_search(query='Florida Keys Reef Visual Census', which='table', url=eurl)
  
  # iterate over years
  all = list()
  
  sprintf('dt%d', c(1999,2000,2004,2006,2008,2010,2012,2014))
  sprintf('fk%d', 1994:2014)
  
  http://gcoos4.tamu.edu:8080/erddap/tabledap/dt2000.html
  
  for (yr in 1994:2014){ # yr = 1994
  
    # construct id for dataset
    id = sprintf('fk%d', yr)
    csv_id   = sprintf('data/fk%d.csv', yr)
    csv_vars = sprintf('data/fk%d_vars.csv', yr)
    cat(sprintf('%s\n', id))
    
    if (!file.exists(csv_vars)){
      # get metadata for dataset
      m = try(info(id, url=eurl), silent = T)
      
      if (class(m) == 'try-error') next
      cat(sprintf('  writing %s\n', csv_vars))
      write_csv(m$variables, csv_vars)
    }
    
    if (!file.exists(csv_id)){
    
      # get metadata for dataset
      m = try(info(id, url=eurl), silent = T)
      
      # if id not found, then move onto next year
      if (class(m) == 'try-error'){
        cat(sprintf('  %s NOT FOUND!\n', id)) # fk2013 NOT FOUND!
        next
      } 
      
      # try fetching data, up to 10x
      dap_attempts = 1
      while (dap_attempts < 11){
        
        # load data for individual dataset
        cat('  fetching data', ifelse(dap_attempts > 1, sprintf(': attempt %d\n', dap_attempts), '\n'))
        d_id = try(tabledap(m, fields=m$variables$variable_name, url=eurl), silent = T)
        
        # break out of loop if not giving error
        if (!'try-error' %in% class(d_id)) break
        dap_attempts =+ 1
        cat('  error fetching data\n')
      }
    
      # write to csv
      cat('  writing to csv\n')
      d_id %>%
        tbl_df() %>%
        write_csv(csv_id)
      
    } # end if (!file.exists(csv_id))
  } # end for (yr in 1994:2014)
  
  # bind all csv's into one data frame
  cat("bind all csv's\n")
  d = data_frame()
  for (f in list.files('data','fk[0-9]+\\.csv', full.names=T)){ # f = list.files('data','fk[0-9]+\\.csv', full.names=T)[1]
    cat(' ', f,'\n')
    d_f = read_csv(
      f, progress=F, trim_ws=T,
      col_types = cols(
        protection = col_character()))
    d = bind_rows(d, d_f)
  }
  
  write_rds(d, rds_d) # 4.4 GB

  # evaluate commonness of columns
  cat('eval common columns')
  vars = data_frame()
  for (f in list.files('data', 'fk[0-9]+_vars\\.csv', full.names = T)){ # f = list.files('data', 'fk[0-9]+_vars\\.csv', full.names = T)[1]
    cat(f)

    vars = bind_rows(
      vars,
      read_csv(f) %>%
        mutate(
          id = str_replace(f, 'data/(.*)_vars\\.csv', '\\1')))
  }
  
  v = vars %>%
    select(variable_name, data_type, id) %>% # drop actual_range
    spread(id, data_type)
  

} else {
  # read data
  d = read_rds(rds_d)
}

# show columns (with same class) not consistently available across all datasets
summary(d)

d %>%
  head() %>%
  datatable()

View(fk$sample_data)
```

### Time Series

# TODO

- reduce size by rm zeros, first capturing all unique locations & days (perhaps `d$materialSampleID`)


### Marker Map

Using "1994 Florida Keys Reef Visual Census" as example dataset since problems with `rerddap` package retrieving information.

More links from metadata:

* [ERDDAP - Information about 1994 Florida Keys Reef Visual Census, v3.2, from ???](http://gcoos4.tamu.edu:8080/erddap/info/fk1994/index.html)
    * [Reef Fish Monitoring in the Florida Keys - Southeast Fisheries Science Center : NOAA : National Marine Fisheries Service](http://www.sefsc.noaa.gov/species/fish/reeffish.htm#keys)
    * [MMI Ontology Registry and Repository](http://mmisw.org/orr/#http://mmisw.org/ont/ioos/marine_biogeography)
    * [Cooperative Multi-Agency Reef Fish Monitoring Protocol - Florida Keys Coral Reef Ecosystem](http://www.coris.noaa.gov/activities/fish_monitoring_protocol/)
    * [RVC | Data Portal](http://www.sefsc.noaa.gov/rvc_analysis20/samples/index)


- **quantificationName**: A name for a derived value or processed data about the occurrence, for example,'Biomass'. The word used in this terminology for such information is "quantification", rather than "abundance", because the word "abundance" may already be associated with specific, rather than general, practices of quantification in biology. Calculated Species Occurence. described in Smith,S.G., et al. 2011

- **quantificationValue**: Mean number of observed fish per species per 5 Minutes, (num)

- **scientificNameIDWoRMS**: A unique taxon identifier obtained by validation of the taxon name with the World Register of Marine Species (WoRMS), www.marinespecies.org.For OBIS-USA, this may be an ITIS taxon serial number or a WoRMS aphia ID, or other similar reference.

- **species_nr**: A number indicating the species in a sample/observation

```{r fk1994 marker map, eval=F}
d_1994 = d %>%
  filter(datasetID == 'FloridaKeysReefVisualCensus1994') %>%
  select(
    class, depth, eventDate, family, genus, habitat, 
  )
  select(-basisOfRecord, -bottomType, -country, -datasetID, -datasetName, -dynamicProperties, -eventDateRemarks, 
         -eventDateTimeZone, -geodeticDatum, -higherInstitutionCode)

d %>%
  summarize(
    sampleR
  )
  group_by(quantificationName) %>%
  summarize(
    qval_min = min(quantificationValue, na.rm=T),
    qval_max = max(quantificationValue, na.rm=T),
    qval_avg = mean(quantificationValue, na.rm=T))


filter(scientificName == 'unknown species')

# quantificationUnit = 'Calculated number of individuals per 5 minutes'

d_sites = d %>%
  group_by(longitude, latitude, eventDate) %>%
  summarize(
    qval_min = min(quantificationValue, na.rm=T),
    qval_max = max(quantificationValue, na.rm=T),
    qval_avg = mean(quantificationValue, na.rm=T))



d_map = d %>%
  rename(
    dtime = `time (UTC)`,
    lon = `longitude (degrees_east)`,
    lat = `latitude (degrees_north)`)

  
library(leaflet)
library(htmltools)
leaflet(data=d_sites) %>%
  addProviderTiles('Esri.OceanBasemap') %>%  # or 'Esri.OceanBasemap'/'Stamen.TonerLite'
  # see [all providers](http://leaflet-extras.github.io/leaflet-providers/preview/index.html)
  addMarkers(
    ~lon, ~lat, 
    popup = ~paste(
      strong("quantificationValue:"), sprintf("%0.3g (%0.3g - %0.3g)", qval_avg, qval_min, qval_max)))
```


## Binning by Hexagons

binning:

- [hexagon_binning.pdf](https://cran.r-project.org/web/packages/hexbin/vignettes/hexagon_binning.pdf)
- for hexagon binning options in R, see [#7: shiny app to slice in space and time to create hexagon map and timeseries plot summaries](https://github.com/marinebon/private/issues/7)

example data:

- [ERDDAP - Search: calcofi](http://coastwatch.pfeg.noaa.gov/erddap/search/index.html?page=1&itemsPerPage=1000&searchFor=calcofi)
- [ERDDAP - CalCOFI Larvae Counts Positive Tows - Data Access Form](http://coastwatch.pfeg.noaa.gov/erddap/tabledap/erdCalCOFIlrvcntpos.html)

```{r hexbin, eval=F}
# missing species?
library(hexbin)

ed_search(query='calcofi haul catch', which='table')

stns = tabledap(info('erdCalCOFIstns'))
lrvcntpos = tabledap(info('erdCalCOFIlrvcntpos'))

# TODO: unique by place+time
d = lrvcntpos %>%
  tbl_df() %>%
  mutate(
    lat = as.numeric(latitude),
    lon = as.numeric(longitude)) %>%
  group_by(lon, lat) %>%
  summarize(
    n_species = n_distinct(scientific_name)) %>%
  ungroup() %>%  
  sample_n(100) # pick random sample of rows from massive dataset

leaflet(data=d) %>%
  addProviderTiles('Esri.OceanBasemap') %>%  # or 'Esri.OceanBasemap'/'Stamen.TonerLite'
  # see [all providers](http://leaflet-extras.github.io/leaflet-providers/preview/index.html)
  addMarkers(
    ~lon, ~lat, 
    popup = ~paste(
      strong("n_species: "), n_species))
```

## Problems with FL Keys Fish Survey dataset

**Where's the data?** See [MBON IOOS: Florida Keys Reef Fish Visual Census](http://mbon.ioos.us/#module-metadata/53cb8d58-ae4d-43e1-aea3-640db9491db2/9436fa4e-73aa-4189-b551-b3b484a9d4e9). Follow the metadata URL and then to [ERDDAP - fk1994 as HTML table](http://gcoos4.tamu.edu:8080/erddap/tabledap/fk1994.htmlTable?time%2CtimeUncertainty%2Clongitude%2Clatitude%2Cdepth%2CminimumDepthInMeters%2CmaximumDepthInMeters%2CunderwaterVisibilityInMeters%2CwaterTemperatureInCelsius%2CquantificationMethod%2CsampleRadiusInMeters%2CquantificationName%2CquantificationValue%2CquantificationStatus%2CquantificationUnit%2CobservedMeanLengthInCm%2CdynamicProperties%2CdataSetID%2CtaxonRank%2CscientificName%2CvernacularName%2Cspecies_cd%2Cspecies_nr%2Cgenus%2Cfamily%2Corder%2Cclass%2Cphylum%2Ckingdom%2Chabitat%2Chabitat_cd%2CprimarySamplingUnit%2CmapGridNumber%2CmapNumber%2Czone_nr%2Csubregion_nr%2Cstation_nr%2CmaterialSampleID%2Ccountry%2CstateProvince%2CwaterBody%2CdatasetName%2Clocality%2CeventDate%2CeventDateTimeZone%2ChigherInstitutionCode%2CinstitutionCode%2CownerInstitutionCode%2CgeodeticDatum%2CbasisOfRecord%2CrecordedBy%2Creferences%2CeventDateRemarks%2CverticalDatum%2Cprotection%2CbottomType%2Cregion&time%3E=1994-10-14T00%3A00%3A00Z&time%3C=1994-10-21T12%3A00%3A00Z). 

- Where are individual species? 
- What is `quantificationValue`?

## Problems with `rerddap`

### Not paging

```{r rerddap not paging, eval=F}
eurl = 'http://gcoos4.tamu.edu:8080/erddap/'

# showing 20 of 26
ed_search(query='Florida Keys Reef Visual Census', which='table', url=eurl)
# no page 2
try(ed_search(query='Florida Keys Reef Visual Census', which='table', url=eurl, page=2))
# page_size not respected
ed_search(query='Florida Keys Reef Visual Census', which='table', url=eurl, page_size=30)
```


### Missing longitude and other data

```{r fk1994 missing data, eval=F}
eurl = 'http://gcoos4.tamu.edu:8080/erddap/'

m = info('fk1994', url=eurl)
m$variables$variable_name
d = tabledap(m, fields=m$variables$variable_name, url=eurl)
table(d$longitude)
```


## Map ERDDAP WMS?

```{r, eval=F}
library(leaflet)

leaflet() %>% 
  addTiles() %>% 
  setView(-84.9185515, 27.7789018, zoom = 7) %>%
  # addWMSTiles(
  #   "http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi",
  #   layers = "nexrad-n0r-900913",
  #   options = WMSTileOptions(format = "image/png", transparent = TRUE),
  #   attribution = "Weather data © 2012 IEM Nexrad")
  # addWMSTiles(
  #   'http://demo.opengeo.org/geoserver/ows?',
  #   layers = 'nasa:bluemarble')
  addWMSTiles(
    "http://coastwatch.pfeg.noaa.gov/erddap/wms/jplMURSST41/request?",
    layers = "jplMURSST41:analysed_sst",
    options = WMSTileOptions(
      exceptions='INIMAGE', 
      version='1.3.0', 
      #srs='EPSG:4326', 
      #srs='CRS:84', 
      srs='CRS:84', 
      layers='jplMURSST41:analysed_sst', 
      time='2016-09-19T09:00:00Z', 
      transparent='true', bgcolor='0x808080', format='image/png'))
  ,
  addWMSTiles(
    "http://coastwatch.pfeg.noaa.gov/erddap/wms/jplMURSST41/request?",
    layers = "jplMURSST41:analysed_sst",
    options = WMSTileOptions(format = "image/png", transparent = TRUE),
    attribution = "SST from NOAA PFEG")
    
  
  
```


## Other

- `rgl::abundance`: Animal abundance, visualization of multi-dimension data using multiple techniques